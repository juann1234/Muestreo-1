---
title: "Muestreo y Planificación de Encuestas Proyecto Final"
author: "Grupo 7: Apolo - Roda - Da Rosa"
format: pdf
editor: visual
---

## Introducción:

En el presente trabajo se utilizará la base de datos de la Encuesta Continua de Hogares (ECH) de Uruguay correspondiente al año 2019, disponible en el repositorio del Instituto Nacional de Estadística (INE) y también proporcionada en el aula virtual del curso. El objetivo principal es aplicar herramientas de muestreo y estimación estadística para procesar información real y analizar la situación de desocupación en distintos segmentos de la población.

```{r}
# Librerias
library(survey)
library(haven)
library(dplyr)
library(here)
library(writexl)

#write_xlsx(encuesta_HP, "encuesta_HP.xlsx")
```

```{r}
# El link a la pagina del IME no anda...

# Lectura de datos
#encuesta_H <- read_sav(here("Datos", "H_2019_Terceros .sav"))
encuesta_P <- read_sav(here("Datos", "P_2019_Terceros.sav"))
encuesta_P
# f89 es la variable que mide "DESOCUPADO EN ÚLTIMOS 12 MESES"
# e27 es la variable que mide la EDAD

#encuesta_HP <- read_sav(here("Datos", "HyP_2019_Terceros.sav")) # la union de los dos anteriores
#encuesta_HP
#encuesta_H
encuesta_P
#encuesta_HP

# Podriamos usar upm_fic del dataframe diseno como argumento en ids~1
diseno <- read_sav(here("Datos", "ESTRATO_UPM_ECH2019.sav"))
#encuesta
diseno



df_unido <- merge(encuesta_P, diseno, by = "numero")
df_unido

#df_unido[, c("estred13", "estrato")]


table(encuesta_P$f89)

```


```{r}
diseño1 <- svydesign(ids = ~upm_fic, strata = ~estred13, weights = ~pesomen, data = df_unido)
diseño1

diseño1 <- svydesign(ids = ~diseno$upm_fic, strata = ~estred13, weights = ~pesomen, data = encuesta_P)

# usar estred13 del dataframe o estrato de la base de datos de diseño? La que rinda mejor supongo.
dim(diseno)
dim(encuesta_P)
encuesta_P
#encuesta_HP
# weights = pesomen ponderador mensual, que es el factor que indica la representatividad de un elemento muestral en la poblacion.
```


## Se pide:

1.  ***Estime el total de personas desocupadas en el primer trimestre del año y proporcione un intervalo de confianza al 95% para este total. ¿Cúanto vale el deff en este caso?\
    ***

La variable `ht6` representa el total de personas desocupadas en cada hogar, calculada por el sistema a partir de la información individual de los integrantes del hogar (excluyendo servicio doméstico). Esta variable incluye a todas las personas que, según la clasificación del INE, se consideran desocupadas, ya sea porque están buscando empleo y disponibles para trabajar, porque están disponibles pero no buscan, o porque buscan sin estar disponibles.\

```{r}
set.seed(123)

# Filtrar primer trimestre
hogares <- df_unido
hogares_trim1 <- filter(hogares, mes %in% c(1, 2, 3))

# Definir diseño muestral
#diseño <- svydesign(ids = ~upm_fic, strata = ~estred13, weights = ~pesotri, data = hogares_trim1)\
diseño1 <- svydesign(ids = ~upm_fic, strata = ~estred13, weights = ~pesomen, data = hogares_trim1)
total_desocupados <- svytotal(~f89, diseño, deff = TRUE)
total_desocupados


# diseño <- svydesign(id = ~upm_fic, strata = ~estrato, weights = ~pesomen, data = df_unido)
# total_desocupados <- svytotal(~f89, diseño, deff = TRUE) # Estimar total de personas desocupadas
# total_desocupados # Mostrar total estimado
# Cuando use estred13 obtengo un Error estándar (SE) más bajo cuando se usa estred13, o sea mayor precisión. Ademas el DEff (Design Effect), también es más bajo con estred13, o sea el muestreo es más eficiente respecto al muestreo aleatorio simple.
table(hogares_trim1$f89)

# Intervalo de confianza al 95%
confint(total_desocupados)

# Efecto de diseño (DEFF)
deff_total <- deff(total_desocupados)
deff_total


#     total     SE   DEff
# ht6 614053  11254 1.2501
#        2.5 %   97.5 %
# ht6 591995.4 636110.6
#      ht6 
# 1.250133 


# 4
```

```{r}

```


se estima que en Uruguay hay aproximadamente 36.273 personas desocupadas. El intervalo de confianza al 95% para esta estimación se encuentra entre 33.807 y 38.739 personas, lo que refleja el rango dentro del cual probablemente se ubica el verdadero total poblacional. El efecto de diseño (DEFF) fue de 1,341, lo cual indica que la varianza del estimador bajo el diseño muestral utilizado es un 34,1% mayor que la que se tendría bajo un muestreo aleatorio simple

\







2.  **Obtenga un intervalo de confianza al 95% para el total estimado en la parte anterior utilizando el método Bootstrap y compare con el punto anterior. Obtenga la distribución empírica del estimador.**

```{r}

#diseño <- svydesign(ids = ~1, weights = ~pesoano, data = hogares_trim1)


set.seed(123)

# Crear diseño replicado Bootstrap
diseño_boot <- as.svrepdesign(diseño, type = "subbootstrap", replicates = 500)

# Estimar total con Bootstrap (guardamos replicados)
desocupados_boot <- svytotal(~f89, diseño_boot, return.replicates = TRUE)

# Mostrar intervalo de confianza al 95%
confint(desocupados_boot)

# Graficar distribución empírica de los pseudo-valores bootstrap
hist(desocupados_boot$replicates,
     breaks = 20,
     main = "Distribución Bootstrap del estimador de ht6",
     xlab = "Total estimado de personas desocupadas")

# Comparación de errores estándar
SE_boot <- sd(desocupados_boot$replicates)  # Bootstrap
SE_clasico <- sqrt(attr(svytotal(~f89, diseño), "var"))  # Clásico

# Mostrar ambos errores estándar
SE_boot
SE_clasico


```

A partir del diseño muestral aplicado a los hogares del primer trimestre y utilizando la variable `ht6`, se estimó un total de 36.273 personas desocupadas. El error estándar obtenido por el método clásico fue de 1.258,2, mientras que el método Bootstrap arrojó un error ligeramente mayor, de 1.336,5. La diferencia entre ambos métodos es pequeña, lo que sugiere que la estimación es robusta. La distribución empírica de los pseudovalores Bootstrap se presenta como aproximadamente simétrica y centrada en el estimador, lo cual respalda la estabilidad del total estimado.

**3. Estime el total de personas desocupadas en el primer trimestre del año en Paysandú y proporcione un intervalo de confianza al 95% para este total.**

```{r}
set.seed(123)

# Filtrar primer trimestre y Paysandú
hogares_paysandu <- df_unido %>%
  filter(mes %in% 1:3, nomdpto == "PAYSANDU")

# Definir diseño muestral
diseño_paysandu <- svydesign(
  ids = ~numero,
  strata = ~estred13,
  weights = ~pesotri,
  data = hogares_paysandu
)

# Estimar total de personas desocupadas
total_paysandu <- svytotal(~f89, diseño_paysandu, deff = TRUE)

# Mostrar total estimado
total_paysandu

# Intervalo de confianza al 95%
confint(total_paysandu)


# El total de personas desocupadas en Paysandu es de 15475
```

**4. Estime la tasa de desocupados en las personas de entre 18 y 25 años y proporcione un intervalo de confianza al 95% para esta estimación.**

```{r}

encuesta_HP_jovenes <- subset(df_unido, e27 >= 18 & e27 <= 25) # Personas entre 18 y 25 años


diseño_jovenes <- svydesign(ids = ~numero,           # identificador sin clusters
                            strata = ~estred13, # estratos
                            weights = ~pesotri, # pesos ponderadores
                            data = encuesta_HP_jovenes) # datos filtrados de personas entre 18 y 25 años

# podensmo svymean porque nos pide la tasa, media(ht6) = (numero de personas desocupadas) / (total personas)
# igual si probas con total te da 570669  jovenes entre 18 y 25 son desempleados, bastante...
svymean(~f89, diseño_jovenes) # estimacion de tasa de desocupados en jovenes de entre 18 y 25 años.



confint(svytotal(~f89, diseño_jovenes))
# Se estima que el 33.3% de las personas de entre 18 y 25 años están desocupadas.
# Con un 95% de confianza, la verdadera tasa poblacional se encuentra entre 32.2% y 34.4%.


# con ids
#  mean     SE
# ht6 0.33276 0.0057
#        2.5 %   97.5 %
# ht6 551161.9 590176.1
```

```{r}

```

**5. Estime tasa de desocupados en las personas de entre 18 y 25 por departamento y proporcione un intervalo de confianza al 95% para cada dominio.**

```{r}
# la variable d23 indica PERSONAS DE 14 O MÁS AÑOS
# entiendo yo que es 1 persona con 14 anios o mas hay 12587 y asi para los demas

#encuesta_HP
encuesta_HP_jovenes <- subset(df_unido, e27 >= 18 & e27 <= 25)
#encuesta_HP_jovenes

# Estimacion
diseno_jovenes <- svydesign(
  ids = ~1,
  strata = ~estred13,
  weights = ~pesotri,
  data = encuesta_HP_jovenes,
  nest = TRUE
)

# Estimacion por departamento
tasas <- svyby(
  ~f89,
  ~nomdpto,  # o dpto si preferís código numérico
  design = diseno_jovenes,
  svytotal,
  vartype = "ci",
  level = 0.95,
  na.rm = TRUE
)

tasas

#diseno_jovenes
#tasas

#sum(tasas$ht6) si sumamos por departamento vemos que la cantidad de desempleados entre 18 y 25 años desagregado por departamento es igual a el total de desempleados original entre 18 y 25 años.

# ci_I es el valor del limite inferior del intervalo de confianza
# ci_u es el valor del limite superior del intervalo de confianza


```



**6. Si no se contara con la información de las UPM y de los estratos, ¿cómo sería el intervalo de confianza de la parte 1)? Comente los resultados.**

```{r}
# UPM sin estratos:

diseño_simple <- svydesign(ids = ~numero, weights = ~pesotri, data = hogares_trim1)
svytotal(~f89, diseño_simple)
confint(svytotal(~f89, diseño_simple))
svytotal(~f89, diseño_simple, deff = TRUE)


# con estratos: 561627.5 666478.5 mas chico
# sin estratos: 561355.4 666750.6 mas grande

```

Tenemos que el total estimado es igual para ambos casos, dado que estamos usando los mismos pesos. El error estándar (SE) es un poco mayor con el diseño que no incluye la información de las UPM y de los estratos.

El intervalo de confianza es un poco más amplio cuando no consideramos la información de las UPM y de los estratos. Esto es porque al no considerar esa informacion, no se reduce la varianza y el diseño es menos eficiente.  El DEFF (factor de diseño) aumenta un poco, pasando de 1.2501 a 1.275, entonces en promedio, el muestreo que considera la informadcion sobre las UPM y los estratos introduce un 25% más de varianza que un muestreo que no considera esta informacion. (?)


3092519 ; 3245211   con info
3108623 ; 3229107   sin info (mas chico)
Ahora me quedo al revez, mas chico el intervalo al no tener informacion.

La conclusion es que si no se tiene la información sobre las UPM y los estratos, se puede hacer la estimación igual, pero los intervalos de confianza son más amplios y el diseño es menos eficiente.
.








```{r}

```
